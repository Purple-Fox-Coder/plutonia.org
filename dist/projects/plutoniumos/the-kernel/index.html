<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Plutonia</title><link rel="stylesheet" href="/_astro/beginnings.DolyQfgP.css"></head> <body>  <nav class="topBar"> <input type="checkbox" id="check"> <label for="check" class="checkbtn"> <p>â‰¡</p> </label> <label class="logo">Plutonia</label> <ul> <li><a href="/">Home</a></li> <li><a href="/about/">About Me</a></li> <li><a href="/portfolio/">Projects</a></li> <li><a href="/contact/">Contact</a></li> </ul> </nav> <div class="mainBody text-center"> <h1>The Kernel</h1> <p>
  Building the kernel: The core of an operating system
  </p> <div class="text-left">  <div class="blog"> <h1>9/4/2025 - The Kernel</h1> <p class="section">
&emsp;The core of the operating system- the infamous kernel... naturally
            instead of just using 32bit as my goto I opt for the probably exponentially
            harder option of going <b>straight to 64bit mode</b>.  So, that's been
            an adventure.  For those crazy like me and find themselves here, these
            are the tools and technologies I'm using:
</p> <pre style="margin-left:5%;">            <p style="white-space:normal">
              1. <a href="https://ziglang.org/">Zig</a>:  Simply has the best built
              in build system I have ever seen.  If you haven't heard of it, as of
              writing it's a newer low level programming language that, as far as
              I have been able to tell, has similar philosophies to C.
            </p>
            <p style="white-space:normal">
              2. <a href="https://www.qemu.org/">Qemu</a>:  A virtual machine, any
              should do.  Qemu is open source and most importantly (to me) it works
              on linux.
            </p>
            <p style="white-space:normal">
              3. A <a href="https://en.wikipedia.org/wiki/VNC">VNC</a> viewer:
              the way I use qemu starts a vnc server, so on linux I use
              <a href="https://apps.kde.org/krdc/">KRDC</a> and on windows I
              use <a href="https://apps.microsoft.com/detail/xp99dvcpgktxnj">Real VNC</a>.
              Are they amazing?  No idea, but they get the job done; that being connect
              and view what the screen is showing.
            </p>
            <p style="white-space:normal">
              4. <a href="https://codeberg.org/Limine/Limine">Limine</a>:   A
              bootloader to make this whole process easier, other options are available
              and you can see some of them on
              <a href="https://wiki.osdev.org/Bootloader">this page of OSdev</a>.
            </p>
            <p style="white-space:normal">
              5. <a href="https://git-scm.com/">Git</a>:   Widely used version control
              system, love it or hate it.. it's pretty good at what it does.
            </p>
            <p style="white-space:normal">
              6. <a href="https://www.gnu.org/software/xorriso/">Xorriso</a>:
              Helps me package my ISO so that I can then run my OS.
            </p>
          </pre> <p class="section">
&emsp;A big help in getting everything going and researching for this project
            has been the <a href="https://wiki.osdev.org/">OSDev wiki</a>.  Now,
            onto the exciting part!  Firstly I had to set up a linker script; you
            don't usually have to do this for most zig/C/C++ programs, but when
            making an OS it is <b>IMPORTANT</b> because otherwise the compiler
            will assume there already IS an OS.
</p> <pre>            <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"></span>
<span class="line"><span style="color:#B392F0">              ENTRY</span><span style="color:#E1E4E8">(_start)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">              SECTIONS</span></span>
<span class="line"><span style="color:#E1E4E8">              {</span></span>
<span class="line"><span style="color:#E1E4E8">                . </span><span style="color:#F97583">=</span><span style="color:#FDAEB7;font-style:italic"> 1M</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                .multiboot : </span><span style="color:#B392F0">ALIGN</span><span style="color:#E1E4E8">(</span><span style="color:#FDAEB7;font-style:italic">4K</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">                  KEEP</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">(.multiboot))</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                .text : </span><span style="color:#B392F0">ALIGN</span><span style="color:#E1E4E8">(</span><span style="color:#FDAEB7;font-style:italic">4K</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                  *</span><span style="color:#E1E4E8">(.text</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                .rodata : </span><span style="color:#B392F0">ALIGN</span><span style="color:#E1E4E8">(</span><span style="color:#FDAEB7;font-style:italic">4K</span><span style="color:#E1E4E8">) { </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">(.rodata</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)  }</span></span>
<span class="line"><span style="color:#E1E4E8">                .data   : </span><span style="color:#B392F0">ALIGN</span><span style="color:#E1E4E8">(</span><span style="color:#FDAEB7;font-style:italic">4K</span><span style="color:#E1E4E8">) { </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">(.data</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">  )  }</span></span>
<span class="line"><span style="color:#E1E4E8">                .bss    : </span><span style="color:#B392F0">ALIGN</span><span style="color:#E1E4E8">(</span><span style="color:#FDAEB7;font-style:italic">4K</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                  *</span><span style="color:#E1E4E8">(COMMON)</span></span>
<span class="line"><span style="color:#F97583">                  *</span><span style="color:#E1E4E8">(.bss</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">                /</span><span style="color:#E1E4E8">DISCARD</span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> :</span></span>
<span class="line"><span style="color:#E1E4E8">                {</span></span>
<span class="line"><span style="color:#F97583">                    *</span><span style="color:#E1E4E8">(.eh_frame)</span></span>
<span class="line"><span style="color:#F97583">                    *</span><span style="color:#E1E4E8">(.comment)</span></span>
<span class="line"><span style="color:#F97583">                    *</span><span style="color:#E1E4E8">(.note.gnu.property)</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">              }</span></span>
<span class="line"><span style="color:#E1E4E8">              </span></span></code></pre>
          </pre> <p class="section">
&emsp;I initially started off by using
<a href="https://www.gnu.org/software/grub/">Grub</a> boot loader, so
            I had opted to use <a href="https://wiki.osdev.org/Multiboot">Multiboot</a> and
            eventually ended up switching to Multiboot2 (the newer variant).  Fortunately
            When I swapped to using Limine as my boot loader it still supports Multiboot2
            without issue so I did not have to change anything.  Limine did require
            a bit more work in terms of setting up my build process though, namely
            importing it, running <a href="https://www.gnu.org/software/make/">make</a>
and then copying over the necessary files into my ISO folder.  Not
            terribly complex, but of note.  Similar to grub though it has a config;
            both were fairly straightforward in usage.
</p> <pre>            <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="zig"><code><span class="line"></span>
<span class="line"><span style="color:#F97583">              const</span><span style="color:#FFAB70"> MAGIC</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">u32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0xe85250d6</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">              const</span><span style="color:#FFAB70"> FLAGS</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">u32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 4</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">              pub</span><span style="color:#F97583"> const</span><span style="color:#FFAB70"> MultibootHeader</span><span style="color:#F97583"> =</span><span style="color:#F97583"> extern</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">                  magic</span><span style="color:#E1E4E8">    : </span><span style="color:#F97583">u32</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#FFAB70"> MAGIC</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">                  flags</span><span style="color:#E1E4E8">    : </span><span style="color:#F97583">u32</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                  length</span><span style="color:#E1E4E8">   : </span><span style="color:#F97583">u32</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                  checksum</span><span style="color:#E1E4E8"> : </span><span style="color:#F97583">u32</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFAB70">                  reserved1</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">u16</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">                  reserved2</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">u16</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">                  end</span><span style="color:#E1E4E8">      : </span><span style="color:#F97583">u32</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 8</span></span>
<span class="line"><span style="color:#E1E4E8">              };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">              export</span><span style="color:#F97583"> var</span><span style="color:#FFAB70"> multiboot</span><span style="color:#E1E4E8">: </span><span style="color:#FFAB70">MultibootHeader</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">8</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">linksection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">".multiboot"</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> .{</span></span>
<span class="line"><span style="color:#E1E4E8">                  .</span><span style="color:#FFAB70">flags</span><span style="color:#F97583">    =</span><span style="color:#FFAB70"> FLAGS</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                  .</span><span style="color:#FFAB70">length</span><span style="color:#F97583">   =</span><span style="color:#79B8FF"> @sizeOf</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">MultibootHeader</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">                  .</span><span style="color:#FFAB70">checksum</span><span style="color:#F97583"> =</span><span style="color:#F97583"> -</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">@as</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">i32</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">@bitCast</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">MAGIC</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> @as</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">i32</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">@bitCast</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">FLAGS</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">+</span></span>
<span class="line"><span style="color:#79B8FF">                                  @sizeOf</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">MultibootHeader</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">              };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">              var</span><span style="color:#FFAB70"> stack_bytes</span><span style="color:#E1E4E8">: [</span><span style="color:#79B8FF">16</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 1024</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">u8</span><span style="color:#F97583"> align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">linksection</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">".bss"</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#F97583"> undefined</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">              export</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> _start</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">callconv</span><span style="color:#E1E4E8">(.</span><span style="color:#FFAB70">Naked</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">noreturn</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                  asm</span><span style="color:#F97583"> volatile</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">                      \ </span><span style="color:#FFAB70">mov</span><span style="color:#F97583"> %</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">stack_top</span><span style="color:#E1E4E8">], </span><span style="color:#F97583">%%</span><span style="color:#FFAB70">rsp</span></span>
<span class="line"><span style="color:#E1E4E8">                      \ </span><span style="color:#F97583">and</span><span style="color:#E1E4E8"> $</span><span style="color:#F97583">-</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">%%</span><span style="color:#FFAB70">rsp</span></span>
<span class="line"><span style="color:#E1E4E8">                      \ </span><span style="color:#FFAB70">call</span><span style="color:#F97583"> %</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">kmain</span><span style="color:#E1E4E8">:</span><span style="color:#FFAB70">P</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">                      :</span></span>
<span class="line"><span style="color:#E1E4E8">                      : [</span><span style="color:#FFAB70">stack_top</span><span style="color:#E1E4E8">] </span><span style="color:#9ECBFF">"i"</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">@as</span><span style="color:#E1E4E8">([</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">align</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">u8</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">@ptrCast</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#FFAB70">stack_bytes</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> @sizeOf</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">@TypeOf</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stack_bytes</span><span style="color:#E1E4E8">))),</span></span>
<span class="line"><span style="color:#E1E4E8">                          [</span><span style="color:#FFAB70">kmain</span><span style="color:#E1E4E8">] </span><span style="color:#9ECBFF">"X"</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">&#x26;</span><span style="color:#FFAB70">kernel</span><span style="color:#E1E4E8">.</span><span style="color:#FFAB70">kernelMain</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                      :</span></span>
<span class="line"><span style="color:#E1E4E8">                  );</span></span>
<span class="line"><span style="color:#E1E4E8">              }</span></span>
<span class="line"><span style="color:#E1E4E8">              </span></span></code></pre>
          </pre> <p class="section">
&emsp;For the sake of simplicity should I want to support multiple
<a href="https://en.wikipedia.org/wiki/Instruction_set_architecture">
CPU architectures</a> (namely aarm64, x86_64, x86) I have seperate files
            with the above in them, then tell zig which one to use.  The above is
            mainly just telling limine how to boot the kernel, and then creating the
<a href="https://en.wikipedia.org/wiki/Call_stack">call stack</a> (setting
            the top of it with the rsp memory register).  From here, I call kernelMain
            and can finally get to work (though I have not got text to render as of
            writing this, and may have to change the
<a href="https://en.wikipedia.org/wiki/Text_mode">text mode</a>
accordingly)
</p> </div>  </div> </div> <footer> <div class="footer-container"> <p>
&copy; 2025 Anna Robinson. All rights reserved. |
<a href="https://plutonia.org">plutonia.org</a> </p> <nav> <ul> <li><a href="/about/">About</a></li> <li><a href="/contact/">Contact</a></li> <li><a href="/privacy/">Privacy Policy</a></li> </ul> </nav> </div> </footer>  </body></html>